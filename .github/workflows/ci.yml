name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# Права, необходимые Pages-workflow'у
permissions:
  contents: read      # читать код
  pages: write        # пушить в gh-pages
  id-token: write     # OIDC для деплоя

# GitHub рекомендует ставить блокировку, чтобы старый деплой отменялся новым
# и не было гонок при публикации Pages
concurrency:
  group: "pages"
  cancel-in-progress: true  #  [oai_citation:0‡GitHub Docs](https://docs.github.com/en/pages/getting-started-with-github-pages/using-custom-workflows-with-github-pages?utm_source=chatgpt.com)

jobs:
  tests:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.11, 3.12]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - name: Configure GitHub Pages
        uses: actions/configure-pages@v5
      - name: Install deps & run tests
        run: |
          pip install -e .
          pip install pytest pytest-cov genbadge[coverage]
          pytest --cov=src --cov-report=xml:coverage.xml
      - name: Generate coverage badge
        if: matrix.python-version == '3.11'
        run: |
          genbadge coverage -i coverage.xml -o coverage.svg
          mkdir public && mv coverage.svg public/
      - name: Upload Pages artifact         # ②
        if: matrix.python-version == '3.11'
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

  deploy:
    needs: tests
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment                    
        uses: actions/deploy-pages@v3
